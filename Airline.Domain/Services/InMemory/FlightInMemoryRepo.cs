using Airline.Domain.Entity;
using Airline.Domain.Data;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace Airline.Domain.Services.InMemory;

/// <summary>
/// ??????????? ??? ?????? ? ???????, ??????????? ? ??????.
/// </summary>
public class FlightInMemoryRepo : IFlightRepo
{
    private readonly List<Flight> _flights;

    /// <summary>
    /// ??????????? ?????? <see cref="FlightInMemoryRepo"/>.
    /// </summary>
    public FlightInMemoryRepo()
    {
        _flights = DataSeeder.Flights;
    }

    /// <summary>
    /// ???????? ?????? ???? ??????.
    /// </summary>
    /// <returns>?????? ???? ??????.</returns>
    public Task<IList<Flight>> GetAll()
    {
        return Task.FromResult<IList<Flight>>(_flights);
    }

    /// <summary>
    /// ???????? ???? ?? ??? id.
    /// </summary>
    /// <param name="id">id ?????.</param>
    /// <returns>???? ? ????????? id ??? null, ???? ???? ?? ??????.</returns>
    public Task<Flight?> GetById(int id)
    {
        var flight = _flights.FirstOrDefault(f => f.Id == id);
        return Task.FromResult(flight);
    }

    /// <summary>
    /// ????????? ????? ???? ? ???????????.
    /// </summary>
    /// <param name="flight">???? ??? ??????????.</param>
    /// <returns>??????????? ????.</returns>
    public Task<Flight> Add(Flight flight)
    {
        _flights.Add(flight);
        return Task.FromResult(flight);
    }

    /// <summary>
    /// ????????? ???????????? ???? ? ???????????.
    /// </summary>
    /// <param name="flight">???? ? ???????????? ???????.</param>
    /// <returns>??????????? ????.</returns>
    public Task<Flight> Update(Flight flight)
    {
        var existingFlight = _flights.FirstOrDefault(f => f.Id == flight.Id);
        if (existingFlight != null)
        {
            existingFlight.Code = flight.Code;
            existingFlight.DeparturePoint = flight.DeparturePoint;
            existingFlight.ArrivalPoint = flight.ArrivalPoint;
            existingFlight.DepartureDate = flight.DepartureDate;
            existingFlight.ArrivalDate = flight.ArrivalDate;
            existingFlight.DepartureTime = flight.DepartureTime;
            existingFlight.TravelTime = flight.TravelTime;
            existingFlight.AircraftType = flight.AircraftType;
        }
        return Task.FromResult(flight);
    }

    /// <summary>
    /// ??????? ???? ?? ??? id.
    /// </summary>
    /// <param name="id">id ????? ??? ????????.</param>
    /// <returns>True, ???? ???? ??? ??????; ????? False.</returns>
    public Task<bool> Delete(int id)
    {
        var flight = _flights.FirstOrDefault(f => f.Id == id);
        if (flight != null)
        {
            _flights.Remove(flight);
            return Task.FromResult(true);
        }
        return Task.FromResult(false);
    }

    /// <summary>
    /// ???????? ?????? ?????? ?? ?????????? ????????.
    /// </summary>
    /// <param name="departurePoint">????? ???????????.</param>
    /// <param name="arrivalPoint">????? ??????????.</param>
    /// <returns>?????? ??????, ??????????????? ?????????? ????????.</returns>
    public Task<IList<Flight>> GetFlightsByRoute(string departurePoint, string arrivalPoint)
    {
        var flights = _flights
            .Where(f => f.DeparturePoint == departurePoint && f.ArrivalPoint == arrivalPoint)
            .ToList();
        return Task.FromResult<IList<Flight>>(flights);
    }

    /// <summary>
    /// ???????? ?????? ?????? ?? ???? ???????? ? ??????? ???????.
    /// </summary>
    /// <param name="aircraftType">??? ????????.</param>
    /// <param name="startDate">????????? ???? ???????.</param>
    /// <param name="endDate">???????? ???? ???????.</param>
    /// <returns>?????? ??????, ??????????????? ????????? ?????????.</returns>
    public Task<IList<Flight>> GetFlightsByAircraftTypeAndPeriod(string aircraftType, DateTime startDate, DateTime endDate)
    {
        var flights = _flights
            .Where(f => f.AircraftType == aircraftType && f.DepartureDate >= startDate && f.DepartureDate <= endDate)
            .ToList();
        return Task.FromResult<IList<Flight>>(flights);
    }

    /// <summary>
    /// ???????? ???-5 ?????? ?? ?????????? ??????????.
    /// </summary>
    /// <returns>?????? ?? 5 ?????? ? ?????????? ??????????? ??????????.</returns>
    public Task<IList<Flight>> GetTop5FlightsByPassengerCount()
    {
        var topFlights = DataSeeder.Bookings
            .GroupBy(b => b.FlightId)
            .OrderByDescending(g => g.Count())
            .Take(5)
            .Join(_flights,
                g => g.Key,
                f => f.Id,
                (g, f) => f)
            .ToList();
        return Task.FromResult<IList<Flight>>(topFlights);
    }

    /// <summary>
    /// ???????? ?????? ?????? ? ??????????? ???????? ? ????.
    /// </summary>
    /// <returns>?????? ?????? ? ??????????? ???????? ? ????.</returns>
    public Task<IList<Flight>> GetFlightsWithMinTravelTime()
    {
        var minTravelTime = _flights.Min(f => f.TravelTime);
        var flights = _flights
            .Where(f => f.TravelTime == minTravelTime)
            .ToList();
        return Task.FromResult<IList<Flight>>(flights);
    }

    /// <summary>
    /// ???????? ??????? ? ???????????? ???????? ?????? ?? ?????????? ?????? ???????????.
    /// </summary>
    /// <param name="departurePoint">????? ???????????.</param>
    /// <returns>??????, ?????????? ??????? ? ???????????? ???????? ??????.</returns>
    public Task<(double AverageLoad, double MaxLoad)> GetFlightLoadByDeparturePoint(string departurePoint)
    {
        var flights = _flights
            .Where(f => f.DeparturePoint == departurePoint)
            .ToList();

        if (!flights.Any())
        {
            return Task.FromResult((0.0, 0.0)); 
        }

        var loads = flights
            .Select(f => DataSeeder.Bookings.Count(b => b.FlightId == f.Id))
            .ToList();

        var averageLoad = loads.Average();
        var maxLoad = (double)loads.Max(); 

        return Task.FromResult((averageLoad, maxLoad));
    }
}