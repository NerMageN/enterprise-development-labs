using Airline.Domain.Entity;
using Airline.Domain.Data;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace Airline.Domain.Services.InMemory;

/// <summary>
/// ??????????? ??? ?????? ? ???????????, ??????????? ? ??????.
/// </summary>
public class PassengerInMemoryRepo : IPassengerRepo
{
    private readonly List<Passenger> _passengers;

    /// <summary>
    /// ?????????????? ????? ????????? ?????? <see cref="PassengerInMemoryRepo"/>.
    /// </summary>
    public PassengerInMemoryRepo()
    {
        _passengers = DataSeeder.Passengers;
    }

    /// <summary>
    /// ???????? ?????? ???? ??????????.
    /// </summary>
    /// <returns>?????? ???? ??????????.</returns>
    public Task<IList<Passenger>> GetAll()
    {
        return Task.FromResult<IList<Passenger>>(_passengers);
    }

    /// <summary>
    /// ???????? ????????? ?? ??? ??????????????.
    /// </summary>
    /// <param name="id">id ?????????.</param>
    /// <returns>???????? ? ????????? id ??? null, ???? ???????? ?? ??????.</returns>
    public Task<Passenger?> GetById(int id)
    {
        var passenger = _passengers.FirstOrDefault(p => p.Id == id);
        return Task.FromResult(passenger);
    }

    /// <summary>
    /// ????????? ?????? ????????? ? ???????????.
    /// </summary>
    /// <param name="passenger">???????? ??? ??????????.</param>
    /// <returns>??????????? ????????.</returns>
    public Task<Passenger> Add(Passenger passenger)
    {
        _passengers.Add(passenger);
        return Task.FromResult(passenger);
    }

    /// <summary>
    /// ????????? ????????????? ????????? ? ???????????.
    /// </summary>
    /// <param name="passenger">???????? ? ???????????? ???????.</param>
    /// <returns>??????????? ????????.</returns>
    public Task<Passenger> Update(Passenger passenger)
    {
        var existingPassenger = _passengers.FirstOrDefault(p => p.Id == passenger.Id);
        if (existingPassenger != null)
        {
            existingPassenger.PassportNumber = passenger.PassportNumber;
            existingPassenger.FullName = passenger.FullName;
        }
        return Task.FromResult(passenger);
    }

    /// <summary>
    /// ??????? ????????? ?? ??? id.
    /// </summary>
    /// <param name="id">id ????????? ??? ????????.</param>
    /// <returns>True, ???? ???????? ??? ??????; ????? False.</returns>
    public Task<bool> Delete(int id)
    {
        var passenger = _passengers.FirstOrDefault(p => p.Id == id);
        if (passenger != null)
        {
            _passengers.Remove(passenger);
            return Task.FromResult(true);
        }
        return Task.FromResult(false);
    }

    /// <summary>
    /// ???????? ?????? ?????????? ? ??????? ????? ?????? ??? ?????????? ?????.
    /// </summary>
    /// <param name="flightId">id ?????.</param>
    /// <returns>?????? ?????????? ? ??????? ????? ??????, ??????????????? ?? ??????? ?????.</returns>
    public Task<IList<Passenger>> GetPassengersWithZeroBaggage(int flightId)
    {
        var passengers = DataSeeder.Bookings
            .Where(b => b.FlightId == flightId && b.BaggageWeight == 0)
            .Join(_passengers,
                b => b.PassengerId,
                p => p.Id,
                (b, p) => p)
            .OrderBy(p => p.FullName)
            .ToList();
        return Task.FromResult<IList<Passenger>>(passengers);
    }
}